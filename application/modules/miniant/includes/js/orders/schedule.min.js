$(function(){$('div.draggable-event').each(function(){var eventObject={title:$.trim($(this).text()),order_id:parseInt($(this).attr('data-orderid'))};$(this).data('eventObject',eventObject);$(this).draggable({zIndex:999,revert:true,revertDuration:0});});$('#schedule-table tfoot th').each(function(){var title=$('#schedule-table thead th').eq($(this).index()).text();if(title=='Tasks'){return;}
$(this).html('<input type="text" placeholder="Search" size="12" />');});var table=$('#schedule-table').DataTable({"bProcessing":true,"bServerSide":false,"bLengthChange":false,"asStripClasses":['odd','even'],"iDisplayLength":5,"sDom":"<'row'<'span8'l><'span8'>ip>rt<'row'<'span8'><'span8'>>","bJQueryUI":false,"sPaginationType":'bootstrap',"columnDefs":[{type:'date-uk',targets:2}],initComplete:function()
{var r=$('#schedule-table tfoot tr');r.find('th').each(function(){$(this).css('padding',8);});$('#schedule-table thead').append(r);$('#search_0').css('text-align','center');},});table.columns().eq(0).each(function(colIdx){$('input',table.column(colIdx).footer()).on('keyup change',function(){table.column(colIdx).search(this.value).draw();});});resources=[];$.each(technicians,function(key,technician){resources.push({id:technician.user_id,name:technician.first_name});});var original_technician=null;$('#calendar').fullCalendar({header:{left:'prev,next today',center:'title',right:'agendaWeek,resourceDay'},buttonText:{agendaWeek:'Week',resourceDay:'Day'},allDaySlot:false,minTime:4,maxTime:24,firstHour:8,defaultView:'resourceDay',snapMinutes:15,defaultEventMinutes:120,slotEventOverlap:false,resources:resources,selectable:false,selectHelper:true,editable:true,droppable:true,eventSources:[{url:base_url+'miniant/orders/schedule/get_appointments',type:'post',data:{order_type:'Repair'},color:'#53DE89',textColor:'black'},{url:base_url+'miniant/orders/schedule/get_appointments',type:'post',data:{order_type:'Breakdown'},color:'#FEE833',textColor:'black'},{url:base_url+'miniant/orders/schedule/get_appointments',type:'post',data:{order_type:'Maintenance'},color:'orange',textColor:'black'},{url:base_url+'miniant/orders/schedule/get_appointments',type:'post',data:{order_type:'Installation'},color:'#5bc0de',textColor:'black'},{url:base_url+'miniant/orders/schedule/get_appointments',type:'post',data:{order_type:'Service'},color:'#d09bee',textColor:'black',is_technician:1}],select:function(start,end,allDay,event,technician){var title=prompt('Event Title:');if(title){if(technician){$('#calendar').fullCalendar('renderEvent',{title:title,start:start,end:end,allDay:allDay,resourceId:technician.id},true);}else{var rid=prompt('Technician ID:');$('#calendar').fullCalendar('renderEvent',{title:title,start:start,end:end,allDay:allDay,resourceId:rid},true);}}
$('#calendar').fullCalendar('unselect');},eventDragStart:function(event,jsEvent,ui,view){original_technician=event.resource;},eventDrop:function(event,dayDelta,minuteDelta,allDay,revertFunc,jsEvent,ui,view){technician=event.resource;if(technician.id!=original_technician.id&&false){event.resource=original_technician;revertFunc();}else{$.post(base_url+'miniant/orders/schedule/update_event',{document_id:event.id,technician_id:event.resource.id,start:event.start.toUTCString(),end:event.end.toUTCString(),title:event.title,all_day:event.allDay,source:event.source},function(data,response,xhrStatus){print_message(data.message,data.type);},'json');}
original_technician=null;$('#calendar').fullCalendar('refetchEvents');$('#calendar').fullCalendar('rerenderEvents');},eventRender:function(event,element){trigger=(supports_touch())?'click':'click';$('.panel-primary').after(event.description);$(element).on('click',function(event2){$('#assignment-'+event.id+'-description').modal();});},eventAfterRender:function(event,element,view){if(event.is_senior=='1'){$(element).addClass('is_senior');}},eventResize:function(event,dayDelta,minuteDelta,revertFunc,jsEvent,ui,view){$.post(base_url+'miniant/orders/schedule/update_event',{event_id:event.id,technician_id:event.resource.id,start:event.start.toUTCString(),end:event.end.toUTCString(),title:event.title,all_day:event.allDay,source:event.source},function(data,response,xhrStatus){print_message(data.message,data.type);},'json');},drop:function(date,allDay,event,ui,resourceDayView,test){var originalEventObject=$(this).data('eventObject');var copiedEventObject=$.extend({},originalEventObject);copiedEventObject.start=date.toUTCString();copiedEventObject.allDay=allDay;order_id=copiedEventObject.order_id;ajax_url=base_url+"miniant/orders/schedule/schedule_assignments";$.post(ajax_url,{order_id:order_id,technician_id:resources[0].id,appointment_date:copiedEventObject.start,},function(data,response,xhrStatus){$.each(data.newevents,function(key,newevent){var eventObject={title:copiedEventObject.title,resourceId:resources[0].id,start:copiedEventObject.start,allDay:copiedEventObject.allDay,id:newevent.id};$('#calendar').fullCalendar('refetchEvents');});},'json');$(this).remove();return false;},loading:function(stillworking){if(!stillworking){$('table.fc-agenda-days').siblings('div').find('div:first').css('height','800px');}}});});function unschedule(button){url=null;if($(button).is('[data-assignment_id]')&&confirm('This will unschedule this job. Are you sure you want to proceed?')){url=base_url+'miniant/orders/schedule/unschedule_assignment/'+$(button).attr('data-assignment_id');}
if(url!=null){$.post(url,function(data,response){$('.modal').modal('hide');location.reload();});}}